## Сервис регистрации и аутентификации
Аутентификация с помощью JWT-токена.

[Swagger](https://github.com/go-park-mail-ru/2024_2_TeamOn_Patreon/blob/polina-auth/docs/api/openapi.yaml)

#### Статус сервиса
Есть две ручки - регистрации и авторизации.
- регистрация - 
  - регистрирует пользователя
  - проставляет токен в куки
  - возвращает 200, если ок, иначе - 400 
- аутентификация - 
  - аутентифицирует пользователя, 
  - проставляет токен в куки
  - возвращает 200, если ок, иначе - 400

Также создана общая middleware, которая аутентифицирует пользователя по куки, 
  - если все ок, передает бизнес модель пользователя в контекст,
  - иначе, возвращает 401

Также создана middleware 
  - для логирования
  - для передачи структуры бизнес-логики

Также создан общий модуль логирования

#### Запуск
```bash
go run main.go
```

_Предварительно необходимо настроить пакеты и обновить зависимости_
- обращаем внимание на название проекта в `go.mod` там должен быть путь до актуального проекта, как ссылка с гита (без https)
Например:
```
module github.com/go-park-mail-ru/2024_2_TeamOn_Patreon/tree/main
```
- также необходимо проверить, что во всех импортах во всех модулях эта ссылка корректна (если исправляли)
- также должны быть либы описанные в `go.mod`
- также версия go должна совпадать


### Структура
- `cmd/microservices/auth`:
  - `main.go` - файл запуска сервиса
  - `api/routers.go` - файл с созданием роутера // пути и обработчики можно найти там

- `internal/auth`:
  - `api` - "_уровень представлений_": ручки, роутинг
    - `api/test` - быстрый тест на доступность, не судите строго
    - `api/models` - фронтовые модели
  - `behavior` - "_бизнес-логика_", логика авторизации
  - `repository` - структура по работе с БД

- `internal/common`: переиспользуемые модули в других сервисах
  - `global` - глобальные константы, в основном, ключи контекста
  - `middlewares`
    - `middlewares/logging.go` - оболочка хэндлера для логирования запросов
    - `middlewares/handler_auth` - оболочка хзндлера, для аутентификации, если ок, кладет в контекст модель пользователя, иначе, возвращает 401
    - `middlewares/common_rep` - оболочка хэндлера, для инициализации структуры бизнес-логикой единой структурой репозитория
  - `interfaces` - абстрактные интерфейсы бизнес логики и репозитория, нужны для `common_rep`
  - `errors` - используемые ошибки
  - `logger` - модуль для логирования

### TODO:

- структура хэндлера
- передать туда бехейвор
- добавить мьютекс в бд
- тесты
- парсинг конфига
- наверно докер и конфиг в билд
- в конфиге прописать куда выводить логги


- swagger
  - [ ] добавить поле роль
  - [ ] добавить 500ки (?)

- common 
  - [x] вынести переиспользуемые модули в общие
  - [ ] [opt] добавить в ошибку http.status (?)
  - [ ] доработать модуль с ошибками
  - [ ] доработать ошибки везде

- services
  - [x] добавить модуль работы с JWT
  - [x] выбрать способ хэширования
  - [x] сделать регистрацию
  - [x] сделать аутентификацию
  - [x] генерация токена

- storage
  - [x] добавить интерфейс взаимодействия с бд
  - [x] интегрировать по интерфейсу заглушку

- transport
  - [x] сделать валидацию данных
  - [x] парсинг данных из тела запроса
  - [x] парсинг токена
  - [x] проставление токена в куки
  - [ ] отправлять сообщение об ошибке

- tests
  - [ ] покрыть всё ГОШНЫМИ тестами, разумеется
    - [x] регистрация
    - [x] логин
    - [x] повторная рега
    - [x] невалидный логин
    - [ ] невалидные данные при регистрации
    - [ ] невалидные данные при логине
    - [ ] тест мэйна (?)
    - [ ] невалидный json при логине
    - [ ] невалидный json при регистрации
  - неиспользуемые мной модули
    - [ ] парсинг jwt токена
  
- other
  - [ ] лекция по API
  
### HELP
1. Проверка покрытия кода
```bash
# генерация файла с информацией о покрытии
go test ./... -coverprofile=c.out
# открытия файла в браузере
go tool cover -html=/path/to/your/c.out
```

### Политика
__Требования к валидации данных__ - [тут](https://github.com/go-park-mail-ru/2024_2_TeamOn_Patreon/blob/polina-auth/docs/%D0%BF%D0%BE%D0%BB%D0%B8%D1%82%D0%B8%D0%BA%D0%B0%20%D0%B0%D1%83%D1%82%D0%B5%D0%BD%D1%82%D0%B8%D1%84%D1%82%D0%BA%D0%B0%D1%86%D0%B8%D0%B8.md)

- [ ] дописать политику
  - процесс регистрации
  - процесс аутентификации
  - структура токена

___
by `PtFux`

#### Ресурсы:
- логгирование с `slog` - [тут](https://habr.com/ru/companies/slurm/articles/798207/)
- роутинг с `gorilla/mux` - [тут](https://habr.com/ru/companies/ruvds/articles/561108/)
